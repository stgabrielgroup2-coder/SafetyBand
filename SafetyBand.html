<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafetyBand Pro | Master Dashboard</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --primary: #1a2a3a; --danger: #e74c3c; --safe: #2ecc71; --info: #3498db; --warning: #f39c12; }
        body { margin: 0; display: flex; font-family: 'Segoe UI', sans-serif; height: 100vh; background: #f4f7f6; overflow: hidden; }
        
        /* Sidebar Styling */
        .sidebar { width: 380px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.3); overflow-y: auto; }
        .card { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        
        #mapBox { flex-grow: 1; height: 100%; z-index: 1; background: #ddd; }
        
        .btn { width: 100%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; margin-top: 5px; transition: 0.2s; }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .btn-safe { background: var(--info); }
        .btn-danger { background: var(--danger); }
        .btn-connect { background: var(--safe); }
        
        /* History Log Styling */
        .log-container { flex-grow: 1; overflow-y: auto; margin-top: 10px; font-size: 0.85em; background: rgba(0,0,0,0.2); border-radius: 5px; padding: 10px; min-height: 200px; border: 1px solid #444; }
        .log-entry { margin-bottom: 8px; border-left: 3px solid var(--danger); padding-left: 8px; animation: fadeIn 0.4s ease; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 0 5px 5px 0; }
        .log-time { color: var(--warning); font-weight: bold; display: block; font-size: 0.9em; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } }

        /* Alert Overlay */
        #overlay { display: none; position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; background: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-top: 8px solid var(--danger); width: 300px; }
        
        .edit-panel { display: none; margin-top: 10px; padding: 10px; background: #2c3e50; border-radius: 5px; border-left: 4px solid var(--warning); }
        .zone-label { background: transparent; border: none; color: white; font-weight: bold; text-shadow: 1px 1px 2px black; pointer-events: none; }
        
        /* Floating Controls */
        .map-controls { position: absolute; bottom: 30px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .float-btn { background: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 20px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>üõ°Ô∏è SafetyBand Pro</h2>
        <div id="status" style="font-size: 0.85em; margin-bottom: 15px; color: #aaa;">Status: System Ready</div>

        <div class="card">
            <h4>1. Zone Management</h4>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-safe" onclick="setMode('safe')">+ SAFE</button>
                <button class="btn btn-danger" onclick="setMode('danger')">+ DANGER</button>
            </div>
            <div id="editPanel" class="edit-panel">
                <span id="editTitle" style="font-size: 0.9em; font-weight: bold;">Adjusting Zone</span>
                <input type="range" id="radiusSlider" min="30" max="1500" value="200" style="width:100%; margin: 10px 0;" oninput="updateZone()">
                <button class="btn" style="background:#444; font-size:10px; padding:5px;" onclick="deleteZone()">DELETE ZONE</button>
            </div>
        </div>

        <div class="card">
            <h4>2. Tracker Settings</h4>
            <input type="text" id="cName" placeholder="Child's Name" style="width:100%; padding:10px; margin-bottom:8px; box-sizing:border-box; border-radius:5px; border:none; outline: none;">
            <button class="btn btn-connect" onclick="registerChild()">ACTIVATE MONITORING</button>
            <button class="btn" style="background:var(--warning); color:black; margin-top:10px;" onclick="simulateMovement()">üß™ SIMULATE EXIT</button>
        </div>
        
        <h4>üïí Alert History (Timeline)</h4>
        <div class="log-container" id="alertLog">
            <div style="color:#777; font-style:italic; text-align:center; padding-top:40px;">No incidents recorded yet.</div>
        </div>
    </div>

    <div id="mapBox"></div>

    <div class="map-controls">
        <button class="float-btn" title="Center on Child" onclick="recenterMap()">üéØ</button>
    </div>

    <div id="overlay">
        <h2 style="color:var(--danger); margin:0;">üö® BREACH DETECTED</h2>
        <p id="alertMsg" style="font-weight:bold; color:#333; margin:15px 0;"></p>
        <button onclick="dismissAlert()" class="btn btn-connect">ACKNOWLEDGE</button>
    </div>

    <script>
        let map, marker, selectedZone = null;
        let mode = null;
        let zones = [];
        let breadcrumbs = [];
        let pathLine;
        let violationCount = 0;
        let isOutsideLogged = false;

        // --- 1. INITIALIZE MAP LAYERS ---
        window.onload = () => {
            map = L.map('mapBox', { zoomControl: false }).setView([14.5995, 120.9842], 16);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Detailed Street Layer (OpenStreetMap)
            const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // High-Res Satellite Layer (Esri)
            const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

            // Street Name Overlay (For Satellite clarity)
            const labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png');

            const baseMaps = { "Detailed Streets": streets, "Satellite View": satellite };
            const overlays = { "Show Street Names": labels };

            L.control.layers(baseMaps, overlays, { position: 'topright' }).addTo(map);

            // Path History Setup
            pathLine = L.polyline([], {color: '#3498db', weight: 4, opacity: 0.7, dashArray: '5, 10'}).addTo(map);
            
            loadZones();
        };

        // --- 2. ZONE MANAGEMENT ---
        function setMode(m) {
            mode = m;
            document.getElementById('status').innerText = `Status: Tap map to place ${m} zone`;
        }

        map.on('click', (e) => {
            if(!mode) { closeEditPanel(); return; }
            const name = prompt(`Enter a label for this ${mode} zone:`);
            if(!name) return;
            
            const color = mode === 'safe' ? '#2ecc71' : '#e74c3c';
            const circle = L.circle(e.latlng, { color, fillColor: color, fillOpacity: 0.25, radius: 200 }).addTo(map);
            circle.bindTooltip(name, {permanent: true, direction: 'center', className: 'zone-label'}).openTooltip();

            const obj = { name, type: mode, circle };
            zones.push(obj);
            saveZones();
            
            circle.on('click', (ev) => {
                L.DomEvent.stopPropagation(ev);
                openEditPanel(obj);
            });
            mode = null;
            document.getElementById('status').innerText = "Status: Zone Saved";
        });

        // --- 3. CORE TRACKING & SAFETY LOGIC ---
        function registerChild() {
            const name = document.getElementById('cName').value || "Tracker";
            if(marker) map.removeLayer(marker);
            marker = L.marker(map.getCenter()).addTo(map).bindPopup(`<b>Monitoring: ${name}</b>`).openPopup();
            document.getElementById('status').innerText = "Status: Live Tracking Active";
            
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(updatePos, (err) => {
                    console.log("GPS Error:", err);
                }, {enableHighAccuracy: true});
            }
        }

        function updatePos(pos) {
            const latlng = pos.coords ? [pos.coords.latitude, pos.coords.longitude] : pos;
            if(!marker) return;
            
            marker.setLatLng(latlng);
            breadcrumbs.push(latlng);
            pathLine.setLatLngs(breadcrumbs);
            checkSafety(latlng);
        }

        function checkSafety(latlng) {
            let inSafe = false;
            let safeZones = zones.filter(z => z.type === 'safe');

            zones.forEach(z => {
                const dist = L.latLng(latlng).distanceTo(z.circle.getLatLng());
                const radius = z.circle.getRadius();

                // Danger Zones trigger instantly
                if(z.type === 'danger' && dist < radius) {
                    triggerAlert(`DANGER: Entered Restricted Area: ${z.name}`);
                    logEvent(`Alert: Entered Danger Zone (${z.name})`);
                }
                if(z.type === 'safe' && dist < radius) inSafe = true;
            });

            // Smart Geofencing: Waits for 4 consecutive "outside" pings to avoid GPS drift false-alarms
            if(safeZones.length > 0 && !inSafe) {
                violationCount++;
                if(violationCount > 4 && !isOutsideLogged) {
                    triggerAlert("WARNING: Child has exited safe boundaries!");
                    logEvent("Exit: Left Safe Boundaries");
                    isOutsideLogged = true;
                }
            } else {
                violationCount = 0;
                isOutsideLogged = false;
            }
        }

        // --- 4. LOGS & ALERTS ---
        function triggerAlert(msg) {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('alertMsg').innerText = msg;
        }

        function dismissAlert() {
            document.getElementById('overlay').style.display = 'none';
            violationCount = 0;
        }

        function logEvent(msg) {
            const logBox = document.getElementById('alertLog');
            if(logBox.innerText.includes("No incidents")) logBox.innerHTML = "";
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">${time}</span> ${msg}`;
            
            logBox.prepend(entry);
        }

        // --- 5. HELPERS & PERSISTENCE ---
        function recenterMap() {
            if(marker) map.panTo(marker.getLatLng());
        }

        function simulateMovement() {
            if(!marker) { alert("Please start monitoring first!"); return; }
            const current = marker.getLatLng();
            const newPos = [current.lat + 0.005, current.lng + 0.005]; // Large jump to exit zone
            updatePos(newPos);
            map.panTo(newPos);
        }

        function saveZones() {
            const data = zones.map(z => ({ name: z.name, type: z.type, lat: z.circle.getLatLng().lat, lng: z.circle.getLatLng().lng, rad: z.circle.getRadius() }));
            localStorage.setItem('sb_pro_combined', JSON.stringify(data));
        }

        function loadZones() {
            const saved = JSON.parse(localStorage.getItem('sb_pro_combined') || "[]");
            saved.forEach(s => {
                const color = s.type === 'safe' ? '#2ecc71' : '#e74c3c';
                const circle = L.circle([s.lat, s.lng], { color, fillColor: color, fillOpacity: 0.25, radius: s.rad }).addTo(map);
                circle.bindTooltip(s.name, {permanent: true, direction: 'center', className: 'zone-label'}).openTooltip();
                const obj = { name: s.name, type: s.type, circle };
                zones.push(obj);
                circle.on('click', (ev) => { L.DomEvent.stopPropagation(ev); openEditPanel(obj); });
            });
        }

        function openEditPanel(obj) {
            selectedZone = obj;
            document.getElementById('editPanel').style.display = 'block';
            document.getElementById('editTitle').innerText = "Adjusting: " + obj.name;
            document.getElementById('radiusSlider').value = obj.circle.getRadius();
            zones.forEach(z => z.circle.setStyle({weight: 2}));
            obj.circle.setStyle({weight: 6, dashArray: ''});
        }

        function updateZone() {
            if(selectedZone) {
                selectedZone.circle.setRadius(document.getElementById('radiusSlider').value);
                saveZones();
            }
        }

        function deleteZone() {
            if(selectedZone) {
                map.removeLayer(selectedZone.circle);
                zones = zones.filter(z => z !== selectedZone);
                saveZones();
                closeEditPanel();
            }
        }

        function closeEditPanel() {
            selectedZone = null;
            document.getElementById('editPanel').style.display = 'none';
            zones.forEach(z => z.circle.setStyle({weight: 2}));
        }
    </script>
</body>
</html> 